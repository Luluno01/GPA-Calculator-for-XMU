const fs = require('fs');
const path = require('path');

class Timeout {
  constructor(time, timeoutCallback, step) {
    this.timeoutCallback = timeoutCallback || (() => {
      console.log('No timeout callback funtion was defined.');
    });
    this.startTime = (new Date()).getTime();
    this.time = time; // In milliseconds
    let _this = this;
    this.int = setInterval(() => {
      if ((new Date()).getTime() - _this.startTime > _this.time) { // Timeout!
        clearInterval(_this.int);
        _this.int = 0;
        _this.timeoutCallback();
      }
    }, step || 1000);
  }

  refresh() {
    this.startTime = (new Date()).getTime();
  }

  stop() {
    clearInterval(this.int);
    this.int = 0;
  }

  static newTimeout = function (time, timeoutCallback, step) {
    return new Timeout(time, timeoutCallback, step);
  }
}

class ScriptsAutoInjector {
  constructor(browserWindow, scripts, beforeInject) {
    this.state = 'idle';
    this.currentIndex = -1;
    this.scripts = scripts; // An array of scripts
    this.beforeInject = beforeInject; // An array of functions
    let length = scripts.length;
    let _this = this;
    browserWindow.webContents.on('did-finish-load', () => {
      if (_this.state == 'pending' && -1 < _this.currentIndex && _this.currentIndex < length) {
        setTimeout(() => {
          _this.browserWindow.webContents.executeJavaScript(_this.beforeInject[_this.currentIndex](_this.scripts[_this.currentIndex]));
          _this.currentIndex++;
        }, 3000);
      }
    });
  }
}

class Lib {
  constructor(index, portal) {
    this.index = index;
    this.portal = portal;
    this.rawData = [];
    this.res = [];
    this.timer = null;

    let scripts = [
      fs.readFileSync(path.join(path.dirname(__dirname), 'portalScript_0.js'), 'utf-8'),
      fs.readFileSync(path.join(path.dirname(__dirname), 'portalScript_1.js'), 'utf-8'),
      fs.readFileSync(path.join(path.dirname(__dirname), 'portalScript_2.js'), 'utf-8')
    ];

    let beforeInject = [
      script => 'let USERNAME = \'' + document.getElementById('username').value.replace(/\\/g, '\\\\').replace(/\'/g, "\\'").replace(/\"/g, '\\"') + '\';let PASSWORD = \'' + document.getElementById('password').value.replace(/\\/g, '\\\\').replace(/\'/g, "\\'").replace(/\"/g, '\\"') + '\';' + script,
      script => script,
      script => script
    ];

    this.injector = new ScriptsAutoInjector(portal, scripts, beforeInject);

    this.onTimeout = () => null;
  }

  getGPA() {
    this.res = JSON.parse(JSON.stringify(this.rawData));
    let totalGPASum = 0
    let totalCreditSum = 0;
    for(let termIndex in this.res) {
      let term = this.res[termIndex];
      let termGPASum = 0;
      let termcreditSum = 0;
      for(let subjectIndex in term.subjects) {
        // Filters
        if()
      }
    }
  }

  onSuccess() {
    this.timer.stop();
    this.timer = null;
  }

  onError() {
    this.injector.state = 'error';
    this.injector.currentIndex = -1;
    this.timer.stop();
    this.timer = null; // Release timer
  }

  prepareRawData() {
    this.injector.currentIndex = 0;
    this.injector.state = 'pending';
    let _this = this;
    this.timer = new Timeout(10000, () => {
      _this.onTimeout();
      _this.timer = null; // Release timer
    });
    this.portal.webContents.loadURL('http://ssfw.xmu.edu.cn/cmstar/index.portal');
  }

  setRawData(rawDataStr) {
    this.rawData = JSON.parse(rawDataStr);
  }


  // http://blog.csdn.net/lowkeysk/article/details/8063816
  static hasClass(obj, cls) {
    return obj.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));
  }

  static addClass(obj, cls) {
    if (!Lib.hasClass(obj, cls)) obj.className += " " + cls;
  }

  static removeClass(obj, cls) {
    if (Lib.hasClass(obj, cls)) {
      var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
      obj.className = obj.className.replace(reg, ' ');
    }
  }

  static toggleClass(obj, cls) {
    if (Lib.hasClass(obj, cls)) {
      Lib.removeClass(obj, cls);
    } else {
      Lib.removeClassaddClass(obj, cls);
    }
  }
  // http://blog.csdn.net/lowkeysk/article/details/8063816

  static show(obj) {
    obj.style.display = '';
  }

  static hide(obj) {
    obj.style.display = 'none';
  }
}

module.exports = Lib;